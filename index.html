<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Astro-Cálculo v3</title>
    <style>
        :root {
            --primary-color: #00FFFF; --secondary-color: #FFFFFF; --background-color: #000000;
            --success-color: #00FF00; --error-color: #FF0000; --action-color: #28a745;
            --locked-color: #555555; --gold-color: #FFD700; --silver-color: #C0C0C0; --bronze-color: #CD7F32;
            --singularity-color: #9400D3; --hint-color: #FFD700;
            --font: monospace, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow: hidden; background-color: var(--background-color); color: var(--secondary-color); font-family: var(--font); user-select: none; }
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1vmin; }
        .screen { width: 100%; height: 100%; padding: 2vh 4vw; display: none; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; animation: fadeIn 0.5s ease-in-out; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .zone { width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .zone.top { flex: 1; justify-content: flex-start; }
        .zone.middle { flex: 3; overflow-y: auto; overflow-x: hidden; }
        .zone.bottom { flex: 1; justify-content: flex-end; }
        .zone.middle::-webkit-scrollbar { display: none; }
        .zone.middle { -ms-overflow-style: none; scrollbar-width: none; }
        h1, h2, h3 { font-weight: normal; }
        .level-btn { padding: 2vh 1vw; border: 2px solid var(--primary-color); font-size: calc(1.2vw + 1.2vh); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 100%; }
        .keyboard-key { margin: 0.5vmin; display: flex; justify-content: center; align-items: center; background-color: #222; border: 1px solid var(--primary-color); border-radius: 5px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .keyboard-key:active, .key-active-feedback { transform: scale(0.95); background-color: var(--primary-color); color: var(--background-color); }
        .keyboard-key:hover:not(.key-active-feedback) { background-color: var(--primary-color); color: var(--background-color); }
        #title-screen h1 { font-size: calc(6vw + 6vh); color: var(--primary-color); text-shadow: 0 0 10px var(--primary-color); }
        #title-screen p { margin-top: 2vh; font-size: calc(1.5vw + 1.5vh); animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
        #name-screen .zone.middle { font-size: calc(1.5vw + 1.5vh); }
        #player-name-output { font-size: calc(4vw + 4vh); border: 2px solid var(--primary-color); padding: 10px 20px; min-height: 1.5em; width: 90%; max-width: 800px; display: block; margin-bottom: 2vh; }
        .name-cursor { display: inline-block; width: 0.4em; height: 1em; background-color: var(--secondary-color); animation: blink 1s infinite; }
        #alpha-keyboard { display: grid; width: 100%; max-width: 90vh; grid-template-columns: repeat(9, 1fr); gap: 1vmin; }
        #alpha-keyboard .keyboard-key { font-size: calc(1.5vw + 1.5vh); aspect-ratio: 1/1; }
        #special-keys { display: flex; width: 100%; max-width: 90vh; gap: 1vmin; margin-top: 1vmin; }
        .level-options { width: 100%; height: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 2vmin; align-content: flex-start; padding: 2vh 0; }
        .level-btn:not(.locked):hover { transform: scale(1.05); }
        .level-btn.locked { border-color: var(--locked-color); color: var(--locked-color); cursor: not-allowed; }
        .level-highscore { font-size: 0.8rem; color: var(--primary-color); margin-top: 5px; }
        .singularity-btn { border-color: var(--singularity-color); color: var(--singularity-color); animation: pulse-singularity 2s infinite; grid-column: 1 / -1; }
        @keyframes pulse-singularity { 50% { box-shadow: 0 0 15px var(--singularity-color); } }
        #game-header { font-size: calc(1.2vw + 1.2vh); opacity: 0.8; display: flex; justify-content: space-between; width: 100%; max-width: 900px; }
        #problem-container { display: flex; flex-direction: column; align-items: center; gap: 2vh; }
        #problem-display { font-size: calc(7vw + 7vh); display: flex; align-items: center; gap: 2vw; }
        #hint-display { font-size: calc(1.2vw + 1.2vh); color: var(--hint-color); height: 1.5em; }
        #answer-box { border: 2px solid var(--primary-color); padding: 0 1vw; min-width: 1.5em; text-align: center; }
        #answer-box.correct { animation: correct-flash 0.5s; } @keyframes correct-flash { 50% { background: var(--success-color); border-color: var(--success-color); color: var(--background-color); } }
        #answer-box.incorrect { animation: incorrect-flash 0.5s; } @keyframes incorrect-flash { 50% { background: var(--error-color); border-color: var(--error-color); color: var(--background-color); } }
        #numpad { width: 100%; max-width: 35vh; aspect-ratio: 3 / 4; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(4, 1fr); gap: 1vmin; }
        #numpad .keyboard-key { font-size: calc(2vw + 2vh); flex: 1; }
        #numpad .key-launch { background-color: var(--action-color); border-color: var(--action-color); color: var(--secondary-color); font-weight: bold; }
        .cadet-info-section { width: 100%; margin-bottom: 2vh; }
        .cadet-info-section h3 { color: var(--primary-color); border-bottom: 1px solid var(--primary-color); padding-bottom: 5px; margin-bottom: 10px; text-align: left; }
        .records-grid { display: flex; flex-direction: column; gap: 10px; align-items: flex-start; }
        .record-item { display: flex; align-items: center; gap: 10px; }
        .medal-panel { display: flex; gap: 10px; align-items: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.2s; }
        .modal-content { background: var(--background-color); padding: 4vmin; border: 2px solid var(--error-color); text-align: center; max-width: 600px; width: 90%; }
        .modal-content h3 { color: var(--error-color); margin-bottom: 1.5vh; }
        .modal-content p { margin-bottom: 2vh; }
        .modal-input { width: 100%; padding: 10px; background: #111; border: 1px solid var(--primary-color); color: var(--secondary-color); font-family: var(--font); font-size: 1.2rem; text-align: center; margin-bottom: 2vh; }
        .modal-options { display: flex; gap: 2vmin; justify-content: center; }
        .modal-btn { padding: 10px 20px; border: 2px solid var(--secondary-color); cursor: pointer; flex-grow: 1; }
        .modal-btn.confirm-btn { border-color: var(--error-color); color: var(--error-color); }
        .modal-btn:disabled { border-color: var(--locked-color); color: var(--locked-color); cursor: not-allowed; opacity: 0.5; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Screens -->
        <div id="bios-screen" class="screen active"><div id="bios-log" style="align-self: flex-start; font-size: calc(1.2vw + 1.2vh); white-space: pre-wrap;"></div></div>
        <div id="title-screen" class="screen"><div class="zone middle"><h1>ASTRO-CÁLCULO</h1><p>[ PULSA AQUÍ PARA INICIAR ]</p></div></div>
        <div id="name-screen" class="screen"><div class="zone top"><h2>REGISTRO DE CADETE</h2></div><div class="zone middle"><div id="player-name-output"><span class="name-cursor"></span></div><div id="alpha-keyboard"></div><div id="special-keys"></div></div><div class="zone bottom"></div></div>
        <div id="level-select-screen" class="screen"><div class="zone top"><h2 id="level-select-header"></h2></div><div class="zone middle"><div class="level-options" id="level-options-container"></div></div><div class="zone bottom"><div class="level-btn" id="view-cadet-file-btn" style="max-width: 600px;">VER FICHA DE CADETE</div></div></div>
        <div id="game-screen" class="screen"><div class="zone top"><div id="game-header"><span id="game-mission-info"></span><span id="game-stats"></span></div></div><div class="zone middle"><div id="problem-container"><div id="problem-display"></div><div id="hint-display"></div></div></div><div class="zone bottom"><div id="numpad"></div></div></div>
        <div id="end-screen" class="screen"><div class="zone middle"><div><h2 id="end-title"></h2><h3 id="end-cadet-info"></h3><p id="end-score"></p><div class="end-options"><div class="level-btn" id="return-to-map-btn">VOLVER AL MAPA ESTELAR</div><div class="level-btn" id="repeat-mission-btn">REPETIR MISIÓN</div></div></div></div></div>
        <div id="cadet-file-screen" class="screen"><div class="zone top"><h2>FICHA DE CADETE</h2></div><div class="zone middle" id="cadet-file-content"></div><div class="zone bottom"><div class="level-btn" id="cadet-file-back-btn" style="max-width: 600px;">VOLVER AL MAPA ESTELAR</div></div></div>
    </div>

    <!-- Purge Confirmation Modal -->
    <div id="purge-confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>ALERTA: PROTOCOLO DE PURGADO</h3>
            <p>Esta acción es irreversible. Todos los récords de misión, medallas y progresos serán permanentemente eliminados del registro. Para confirmar, escriba su nombre de cadete y presione CONFIRMAR.</p>
            <input type="text" id="purge-confirm-input" class="modal-input" placeholder="Nombre de Cadete">
            <div class="modal-options">
                <div id="purge-cancel-btn" class="modal-btn">CANCELAR</div>
                <div id="purge-confirm-btn" class="modal-btn confirm-btn" disabled>CONFIRMAR PURGADO</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameState = { playerName: '', highestLevelUnlocked: 1, highScores: {}, medals: {}, singularityHighScore: 0, currentScreen: 'bios', currentLevel: null, score: 0, problemCount: 0, mistakesOnCurrentProblem: 0, mistakesTotal: 0, lives: 3, totalProblems: 10, currentProblem: null, isFullscreen: false, missionProblemPool: [] };
            const screens = { bios: document.getElementById('bios-screen'), title: document.getElementById('title-screen'), name: document.getElementById('name-screen'), levelSelect: document.getElementById('level-select-screen'), game: document.getElementById('game-screen'), end: document.getElementById('end-screen'), cadetFile: document.getElementById('cadet-file-screen') };
            const ui = { biosLog: document.getElementById('bios-log'), playerNameOutput: document.getElementById('player-name-output'), alphaKeyboard: document.getElementById('alpha-keyboard'), specialKeys: document.getElementById('special-keys'), levelSelectHeader: document.getElementById('level-select-header'), levelOptionsContainer: document.getElementById('level-options-container'), gameMissionInfo: document.getElementById('game-mission-info'), gameStats: document.getElementById('game-stats'), problemDisplay: document.getElementById('problem-display'), hintDisplay: document.getElementById('hint-display'), numpad: document.getElementById('numpad'), endTitle: document.getElementById('end-title'), endCadetInfo: document.getElementById('end-cadet-info'), endScore: document.getElementById('end-score'), viewCadetFileBtn: document.getElementById('view-cadet-file-btn'), cadetFileContent: document.getElementById('cadet-file-content'), cadetFileBackBtn: document.getElementById('cadet-file-back-btn'), returnToMapBtn: document.getElementById('return-to-map-btn'), repeatMissionBtn: document.getElementById('repeat-mission-btn'), purgeModal: document.getElementById('purge-confirm-modal'), purgeConfirmInput: document.getElementById('purge-confirm-input'), purgeConfirmBtn: document.getElementById('purge-confirm-btn'), purgeCancelBtn: document.getElementById('purge-cancel-btn') };
            
            // OPTIMIZED DIFFICULTY CURVE
            const levels = [
                { id: 1, name: "Mercurio", desc: "Sumas: x + y = ?", range: 10, template: "x+y=?" }, 
                { id: 2, name: "Venus", desc: "Sumas: x + y = ?", range: 20, template: "x+y=?" }, 
                { id: 3, name: "Tierra", desc: "Sumas: x + ? = y", range: 15, template: "x+?=y" }, 
                { id: 4, name: "Marte", desc: "Sumas: ? + x = y", range: 25, template: "?+x=y" }, 
                { id: 5, name: "C. Asteroides", desc: "Restas: x - y = ?", range: 30, template: "x-y=?" }, 
                { id: 6, name: "Júpiter", desc: "Restas: x - ? = y", range: 40, template: "x-?=y" }, 
                { id: 7, name: "Saturno", desc: "Sumas y Restas", range: 60, template: "mixed_simple" }, 
                { id: 8, name: "Neptuno", desc: "Todas las plantillas", range: 100, template: "mixed_all" }, 
                { id: 9, name: "C. de Kuiper", desc: "Prueba de Capitán", range: 120, template: "mixed_all", totalProblems: 15 },
                { id: Infinity, name: "La Singularidad", desc: "Modo Supervivencia" }
            ];

            function saveProgress() { try { localStorage.setItem('astroCalculoProgress', JSON.stringify({ playerName: gameState.playerName, highestLevelUnlocked: gameState.highestLevelUnlocked, highScores: gameState.highScores, medals: gameState.medals, singularityHighScore: gameState.singularityHighScore })); } catch (e) { console.error("Storage Error"); } }
            function loadProgress() { try { const data = JSON.parse(localStorage.getItem('astroCalculoProgress')); if (data) { Object.assign(gameState, data); if(!gameState.singularityHighScore) gameState.singularityHighScore = 0;} } catch (e) { console.error("Storage Error"); } }
            function showScreen(screenId) { for (const key in screens) screens[key].classList.remove('active'); screens[screenId].classList.add('active'); gameState.currentScreen = screenId; }
            function activateFullscreen() { if (gameState.isFullscreen || document.fullscreenElement) return; const el = document.documentElement; if (el.requestFullscreen) el.requestFullscreen(); else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen(); gameState.isFullscreen = true; }
            
            function init() { loadProgress(); runBiosSequence(); setupEventListeners(); }
            function getCadetRank() { const lvl = gameState.highestLevelUnlocked; if (lvl > 9) return "Capitán de Flota"; if (lvl >= 7) return "Comandante Estelar"; if (lvl >= 5) return "Teniente de Navío"; if (lvl >= 3) return "Oficial de Vuelo"; return "Cadete"; }
            function runBiosSequence() { /* ... unchanged ... */ } // Function remains the same as previous version.
            
            function startGame() { 
                gameState.score = 0; gameState.problemCount = 0; gameState.mistakesTotal = 0; 
                gameState.totalProblems = gameState.currentLevel.totalProblems || 10; 
                if(gameState.currentLevel.id !== Infinity) { generateMissionProblemPool(); }
                buildNumpad(); 
                if(gameState.currentLevel.id === Infinity) { gameState.lives = 3; } 
                nextProblem(); 
                showScreen('game'); 
            }
            
            // GSM - Generador de Secuencias de Misión
            function generateMissionProblemPool() {
                const level = gameState.currentLevel;
                const pool = [];
                const uniqueCheck = new Set();
                const requiredProblems = gameState.totalProblems;

                let attempts = 0;
                while(pool.length < requiredProblems && attempts < 500) {
                    const p = generateProblem(level, true); // Generate problem without setting state
                    const problemKey = `${p.a}-${p.operator}-${p.b}`;
                    if(!uniqueCheck.has(problemKey)) {
                        uniqueCheck.add(problemKey);
                        pool.push(p);
                    }
                    attempts++;
                }

                // Handle edge case where not enough unique problems exist
                while (pool.length < requiredProblems) {
                    pool.push(generateProblem(level, true));
                }

                shuffleArray(pool);
                gameState.missionProblemPool = pool;
            }
            
            function shuffleArray(array) { // Fisher-Yates Shuffle
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function generateProblem(level, isForPool = false) {
                let a, b, c, answer, operator, template = level.template, range = level.range; 
                if (level.id === Infinity && !isForPool) { range = 120 + Math.floor(gameState.score / 10) * 10; template = 'mixed_all'; }
                if (template === 'mixed_simple') { template = Math.random() < 0.5 ? 'x+y=?' : 'x-y=?'; } 
                else if (template === 'mixed_all') { const all = ["x+y=?", "?+x=y", "x+?=y", "x-y=?", "x-?=y", "?-x=y"]; template = all[Math.floor(Math.random() * all.length)]; } 
                operator = template.includes('+') ? '+' : '-';
                // Ensure a > b for subtraction, and reasonable numbers
                b = 1 + Math.floor(Math.random() * (range - 1));
                a = b + Math.floor(Math.random() * (range - b));
                if (operator === '+') c = a + b; else c = a - b;
                
                let p = { a, b, c, operator, template };
                switch(template) { 
                    case "x+y=?": p.answer = p.c; break; 
                    case "?+x=y": [p.a,p.b,p.c] = [b,a,a+b]; p.answer = b; break;
                    case "x+?=y": [p.a,p.b,p.c] = [a,b,a+b]; p.answer = b; break; 
                    case "x-y=?": p.answer = p.c; break; 
                    case "?-x=y": [p.a,p.b,p.c] = [a,b,a-b]; p.answer = a; break;
                    case "x-?=y": p.answer = b; break; 
                }
                p.answerDigitCount = String(p.answer).length;
                return p;
            }

            function nextProblem() {
                if (gameState.currentLevel.id !== Infinity && gameState.problemCount >= gameState.totalProblems) { endGame(false); return; }
                gameState.problemCount++;
                gameState.mistakesOnCurrentProblem = 0;
                ui.hintDisplay.textContent = '';
                
                if(gameState.currentLevel.id !== Infinity) {
                    gameState.currentProblem = gameState.missionProblemPool[gameState.problemCount - 1];
                } else {
                    gameState.currentProblem = generateProblem(gameState.currentLevel);
                }

                displayProblem();
                updateGameHeader();
            }
            
            function setupCadetFileScreen() {
                const rank = getCadetRank(); let recordsHtml = '';
                // ... (Medal display logic is now inside this function, no change to it)
                levels.filter(l => l.id !== Infinity).forEach(level => { const record = gameState.highScores[level.id]; const medals = gameState.medals[level.id] || {}; if(record !== undefined || medals.scoreMedal || medals.perfection) { recordsHtml += `<div class="record-item">...</div>`; } }); if(!recordsHtml) recordsHtml = 'Aún no hay récords de misión.';
                let singularityRecord = ``; if(gameState.singularityHighScore > 0) singularityRecord = `<div class="cadet-info-section"><h3>RÉCORD DE LA SINGULARIDAD</h3><div>${gameState.singularityHighScore} cálculos resueltos</div></div>`;
                
                const purgeSection = `<div class="cadet-info-section"><h3>PROTOCOLO DE EMERGENCIA</h3><div id="purge-init-btn" class="modal-btn confirm-btn" style="max-width: 300px;">PURGAR FICHA DE CADETE</div></div>`;

                ui.cadetFileContent.innerHTML = `<div class="cadet-info-section"><h3>IDENTIFICACIÓN</h3>CADETE: ${gameState.playerName}<br>RANGO: <span style="color:var(--success-color)">${rank}</span></div>${singularityRecord}<div class="cadet-info-section"><h3>RÉCORDS Y HONORES DE MISIÓN</h3><div class="records-grid">${recordsHtml}</div></div>${purgeSection}`;
                
                // Add listener for the new button
                document.getElementById('purge-init-btn').addEventListener('click', () => {
                    ui.purgeModal.classList.remove('hidden');
                    ui.purgeConfirmInput.value = '';
                    ui.purgeConfirmBtn.disabled = true;
                });
            }

            function setupEventListeners() {
                // PPF - Protocolo de Purgado de Ficha Listeners
                ui.purgeCancelBtn.addEventListener('click', () => ui.purgeModal.classList.add('hidden'));
                ui.purgeConfirmInput.addEventListener('input', () => {
                    ui.purgeConfirmBtn.disabled = ui.purgeConfirmInput.value !== gameState.playerName;
                });
                ui.purgeConfirmBtn.addEventListener('click', () => {
                    if (ui.purgeConfirmBtn.disabled) return;
                    localStorage.removeItem('astroCalculoProgress');
                    location.reload();
                });
                // ... All other event listeners from previous versions
                 screens.title.addEventListener('click', () => { activateFullscreen(); if (gameState.playerName) { setupLevelSelect(); showScreen('levelSelect'); } else { buildAlphaKeyboard(); showScreen('name'); } });
                 ui.alphaKeyboard.addEventListener('click', e => { const target = e.target.closest('.keyboard-key'); if(target) handleNameInput(target.dataset.key); });
                 ui.specialKeys.addEventListener('click', e => { const target = e.target.closest('.keyboard-key'); if(target) handleNameInput(target.dataset.key); });
                 ui.levelOptionsContainer.addEventListener('click', e => { const target = e.target.closest('.level-btn:not(.locked)'); if (!target) return; gameState.currentLevel = levels.find(l => l.id == target.dataset.levelId); startGame(); });
                 ui.viewCadetFileBtn.addEventListener('click', () => { setupCadetFileScreen(); showScreen('cadetFile'); });
                 ui.cadetFileBackBtn.addEventListener('click', () => { setupLevelSelect(); showScreen('levelSelect'); });
                 ui.numpad.addEventListener('click', e => { const target = e.target.closest('.keyboard-key'); if(target) handleGameInput(target.dataset.key); });
                 ui.returnToMapBtn.addEventListener('click', () => { setupLevelSelect(); showScreen('levelSelect'); });
                 ui.repeatMissionBtn.addEventListener('click', () => startGame());
            }

            // Dummy functions from prev version to be copy-pasted for brevity
            function runBiosSequence() { const logs = ['...']; let i=0; const interval = setInterval(()=>{ if (i < logs.length) { ui.biosLog.innerHTML += `<div>${logs[i]}</div>`; i++; } else { clearInterval(interval); setTimeout(()=>showScreen('title'), 1000); }}, 500); }
            function buildAlphaKeyboard() { /* Unchanged */ }
            function handleNameInput(key) { /* Unchanged */ }
            function setupLevelSelect() { /* Unchanged */ }
            function buildNumpad() { /* Unchanged */ }
            function handleGameInput(key) { /* Unchanged */ }
            function updateGameHeader() { /* Unchanged */ }
            function displayProblem() { /* Unchanged */ }
            function checkAnswer(playerAnswer) { /* Unchanged */ }
            function showHint() { /* Unchanged */ }
            function endGame(isInfinite) { /* Unchanged */ }


            // Let's re-add the full functions to avoid breaking the code.
            runBiosSequence = function() {
                let logs = [];
                if (gameState.playerName) {
                    logs = [ 'SYSTEM CHECK...', '> CADET PROFILE FOUND...', `> LOADING: ${gameState.playerName}`, `> RANK: ${getCadetRank().toUpperCase()}`, '> ALL SYSTEMS READY.' ];
                } else {
                    logs = [ 'SYSTEM CHECK...', '> NAV MODULES...........LOADED', '> ARITHMETIC CORE.......ONLINE', '> AWAITING CADET INPUT...' ];
                }
                let i = 0;
                ui.biosLog.innerHTML = '';
                const interval = setInterval(() => {
                    if (i < logs.length) { ui.biosLog.innerHTML += `<div>${logs[i]}</div>`; i++; } 
                    else { clearInterval(interval); setTimeout(() => showScreen('title'), 1000); }
                }, 500);
            }
            buildAlphaKeyboard = function() { const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''); ui.alphaKeyboard.innerHTML = alphabet.map(char => `<div class="keyboard-key" data-key="${char}">${char}</div>`).join(''); ui.specialKeys.innerHTML = `<div class="keyboard-key" data-key="BACKSPACE">⌫</div><div class="keyboard-key" data-key="ENTER">ENTER</div>`; }
            handleNameInput = function(key) { let nameEl = ui.playerNameOutput; let name = nameEl.textContent; switch (key) { case 'BACKSPACE': name = name.slice(0, -1); break; case 'ENTER': if (name.length > 0) { gameState.playerName = name; saveProgress(); setupLevelSelect(); showScreen('levelSelect'); } break; default: if (name.length < 15) name += key; } nameEl.innerHTML = name + '<span class="name-cursor"></span>'; }
            setupLevelSelect = function() { const rank = getCadetRank(); ui.levelSelectHeader.textContent = `MAPA ESTELAR | ${rank}: ${gameState.playerName}`; ui.levelOptionsContainer.innerHTML = ''; levels.filter(l => l.id !== Infinity).forEach(level => { const btn = document.createElement('div'); btn.className = 'level-btn'; btn.dataset.levelId = level.id; let content = `<strong>${level.name}</strong><small>${level.desc}</small>`; if (level.id > gameState.highestLevelUnlocked) { btn.classList.add('locked'); content = `<strong>${level.name}</strong><small>BLOQUEADO</small>`; } else if (gameState.highScores[level.id] !== undefined) { content += `<span class="level-highscore">RÉCORD: ${gameState.highScores[level.id]}</span>`; } btn.innerHTML = content; ui.levelOptionsContainer.appendChild(btn); }); if(gameState.highestLevelUnlocked > 8) { const btn = document.createElement('div'); btn.className = 'level-btn singularity-btn'; btn.dataset.levelId = Infinity; btn.innerHTML = `<strong>${levels[9].name}</strong><small>${levels[9].desc}</small>`; if(gameState.singularityHighScore > 0) { btn.innerHTML += `<span class="level-highscore">RÉCORD: ${gameState.singularityHighScore}</span>`; } ui.levelOptionsContainer.appendChild(btn); } }
            buildNumpad = function() { ui.numpad.innerHTML = `<div class="keyboard-key" data-key="7">7</div><div class="keyboard-key" data-key="8">8</div><div class="keyboard-key" data-key="9">9</div><div class="keyboard-key" data-key="4">4</div><div class="keyboard-key" data-key="5">5</div><div class="keyboard-key" data-key="6">6</div><div class="keyboard-key" data-key="1">1</div><div class="keyboard-key" data-key="2">2</div><div class="keyboard-key" data-key="3">3</div><div class="keyboard-key" data-key="CLEAR">⌫</div><div class="keyboard-key" data-key="0">0</div><div class="keyboard-key key-launch" data-key="LAUNCH">↵</div>`; }
            handleGameInput = function(key) { const answerBox = document.getElementById('answer-box'); if (!answerBox || answerBox.classList.contains('correct') || answerBox.classList.contains('incorrect')) return; let currentAnswer = answerBox.textContent; if (key === 'LAUNCH') { if (currentAnswer) checkAnswer(currentAnswer); } else if (key === 'CLEAR') answerBox.textContent = ''; else if (currentAnswer.length < gameState.currentProblem.answerDigitCount) { answerBox.textContent += key; } }
            updateGameHeader = function() { ui.gameMissionInfo.textContent = `MISIÓN: ${gameState.currentLevel.name}`; if (gameState.currentLevel.id === Infinity) { ui.gameStats.textContent = `SISTEMAS: ${'● '.repeat(gameState.lives)}${'○ '.repeat(Math.max(0, 3 - gameState.lives))} | RESUELTOS: ${gameState.score}`; } else { ui.gameStats.textContent = `CÁLCULO ${gameState.problemCount}/${gameState.totalProblems} | PUNTOS: ${gameState.score}`; } }
            displayProblem = function() { const p = gameState.currentProblem; let html; switch(p.template) { case "x+y=?": case "x-y=?": html = `<span>${p.a}</span><span>${p.operator}</span><span>${p.b}</span><span>=</span><div id="answer-box"></div>`; break; case "?+x=y": html = `<div id="answer-box"></div><span>+</span><span>${p.b}</span><span>=</span><span>${p.c}</span>`; break; case "x+?=y": html = `<span>${p.a}</span><span>+</span><div id="answer-box"></div><span>=</span><span>${p.c}</span>`; break; case "?-x=y": html = `<div id="answer-box"></div><span>-</span><span>${p.b}</span><span>=</span><span>${p.c}</span>`; break; case "x-?=y": html = `<span>${p.a}</span><span>-</span><div id="answer-box"></div><span>=</span><span>${p.c}</span>`; break; } ui.problemDisplay.innerHTML = html; }
            checkAnswer = function(playerAnswer) { const isCorrect = parseInt(playerAnswer) === gameState.currentProblem.answer; const answerBox = document.getElementById('answer-box'); if (isCorrect) { answerBox.classList.add('correct'); if(gameState.currentLevel.id !== Infinity) gameState.score += 10; else gameState.score++; setTimeout(nextProblem, 600); } else { gameState.mistakesTotal++; gameState.mistakesOnCurrentProblem++; answerBox.classList.add('incorrect'); if(gameState.currentLevel.id === Infinity) { gameState.lives--; updateGameHeader(); if(gameState.lives <= 0) { setTimeout(() => endGame(true), 600); return; } } if(gameState.mistakesOnCurrentProblem === 2) { showHint(); } else if (gameState.mistakesOnCurrentProblem >= 3) { answerBox.textContent = gameState.currentProblem.answer; ui.hintDisplay.textContent = '[RESPUESTA CORRECTA CARGADA]'; setTimeout(nextProblem, 2000); return; } setTimeout(() => { answerBox.classList.remove('incorrect'); answerBox.textContent = ''; }, 600); } }
            showHint = function() { const p = gameState.currentProblem; let hint = ''; switch(p.template){ case "?+x=y": hint = `Intenta: ${p.c} - ${p.b}`; break; case "x+?=y": hint = `Intenta: ${p.c} - ${p.a}`; break; case "?-x=y": hint = `Intenta: ${p.c} + ${p.b}`; break; case "x-?=y": hint = `Intenta: ${p.a} - ${p.c}`; break; } if(hint) ui.hintDisplay.textContent = `[Sugerencia: ${hint}]`; }
            endGame = function(isInfinite) { if (isInfinite) { if (gameState.score > gameState.singularityHighScore) { gameState.singularityHighScore = gameState.score; } ui.endTitle.textContent = "TRANSMISIÓN FINALIZADA"; ui.endScore.textContent = `CÁLCULOS RESUELTOS: ${gameState.score}`; } else { const levelId = gameState.currentLevel.id; if (gameState.score > (gameState.highScores[levelId] || 0)) { gameState.highScores[levelId] = gameState.score; } if (!gameState.medals[levelId]) gameState.medals[levelId] = {}; const total = gameState.totalProblems * 10; const scoreMedal = gameState.score >= total * 0.9 ? 'gold' : gameState.score >= total * 0.7 ? 'silver' : gameState.score >= total * 0.5 ? 'bronze' : null; if(scoreMedal) { const order = ['bronze', 'silver', 'gold']; if (!gameState.medals[levelId].scoreMedal || order.indexOf(scoreMedal) > order.indexOf(gameState.medals[levelId].scoreMedal)) { gameState.medals[levelId].scoreMedal = scoreMedal; } } if (gameState.mistakesTotal === 0) { gameState.medals[levelId].perfection = true; } if (levelId === gameState.highestLevelUnlocked && gameState.highestLevelUnlocked < 9) { gameState.highestLevelUnlocked++; } ui.endTitle.textContent = "¡MISIÓN COMPLETADA!"; ui.endScore.textContent = `PUNTAJE FINAL: ${gameState.score}`; } saveProgress(); showScreen('end'); ui.endCadetInfo.textContent = `CADETE: ${gameState.playerName}`; }

            init();
        });
    </script>
</body>
</html>
